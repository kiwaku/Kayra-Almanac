---
import Base from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import ArtifactRow from '../components/ArtifactRow.astro';
import ProjectBadges from '../components/ProjectBadges.astro';

const logbook = (await getCollection('logbook'))
  .sort((a,b)=> a.data.date < b.data.date ? 1 : -1)
  .slice(0,5);

const flagships = (await getCollection('projects')).filter(p => p.data.featured);

// Generate markdown representation of featured content
const rawMarkdown = `# Featured Projects

${flagships.map(p => `## ${p.data.title} (${p.data.year})

${p.data.summary ? p.data.summary.replace(/<[^>]*>/g, '').replace(/&mdash;/g, '—').replace(/&#x3C;/g, '<').replace(/&#x3E;/g, '>') : p.body}

Status: ${p.data.status}
${p.data.metrics?.loc ? `LOC: ${p.data.metrics.loc}` : ''}
`).join('\n---\n\n')}

# Latest Logbook

${logbook.map(e => `- ${e.data.date} — ${e.data.title}${e.data.anomaly ? ' ⚠︎' : ''}`).join('\n')}`;
---
<Base title="Kayra — Workshop Almanac" rawMarkdown={rawMarkdown}>
  <section class="home">
    <p class="index-kicker">
      Three flagship builds. <em class="muted">Full list in</em>
      <a href="/catalog">CATALOG</a>
    </p>

    <ol class="diamondlist">
      {await Promise.all(flagships.map(async (project) => {
        const { data } = project;
        const { Content } = await project.render();
        return (
          <li class="block" id={data.id}>
            <h2>
              <a href={`/projects/${data.id}`}>{data.title}</a>
              <span class="muted">({data.year})</span>
              <ProjectBadges featured={data.featured} badges={data.badges} />
            </h2>
            <div class="abstract">
              {data.summary ? <div set:html={data.summary} /> : <Content />}
            </div>
            <ArtifactRow artifacts={data.artifacts} images={data.images} projectId={data.id} />
            <div class="badges">
              {data.metrics?.loc && <span class="badge">LOC {data.metrics.loc}</span>}
              {data.metrics?.gpu_hours && <span class="badge">GPU {data.metrics.gpu_hours}h</span>}
              {data.metrics?.boot_sec && <span class="badge">BOOT {data.metrics.boot_sec}s</span>}
              <span class={`badge ${data.status}`}>{data.status}</span>
            </div>
          </li>
        );
      }))}
    </ol>

    <h3>Latest Logbook</h3>
    <ul class="loglist">
      {logbook.map(e=> (
        <li id={e.slug}>
          <a href={`/logbook#${e.slug}`}>{e.data.date} — {e.data.title}</a>
          {e.data.anomaly && <span style="color:#b33a3a;"> ⚠︎</span>}
        </li>
      ))}
    </ul>
  </section>
</Base>
