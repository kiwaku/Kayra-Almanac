---
import Base from '../layouts/SectionLayout.astro';
import { getCollection } from 'astro:content';
const entries = (await getCollection('logbook'))
  .sort((a,b)=> a.data.date < b.data.date ? 1 : -1);
const byYear = entries.reduce((acc, e)=>{
  const y = e.data.date.slice(0,4);
  (acc[y] ||= []).push(e);
  return acc;
}, {} as Record<string, typeof entries>);

// Generate markdown
const rawMarkdown = `# Logbook — All Entries

${Object.entries(byYear).sort(([a],[b]) => Number(b) - Number(a)).map(([year, list]) => `## ${year}

${list.map(e => `### ${e.data.date} — ${e.data.title}

Tags: ${e.data.tags.join(', ')}${e.data.project ? `
Project: ${e.data.project}` : ''}${e.data.anomaly ? `
⚠︎ Anomaly` : ''}
`).join('\n')}`).join('\n')}`;
---
<Base title="Logbook" rawMarkdown={rawMarkdown}>
  <h1>Logbook</h1>
  {Object.entries(byYear).sort(([a],[b]) => Number(b) - Number(a)).map(([y, list])=> (
    <>
      <h2 class="year">{y}</h2>
      <ul class="loglist">
        {list.map(e=> (
          <li id={e.slug}>
            {e.data.anomaly && <span style="color:#b33a3a;">⚠︎ </span>}
            <a href={`/logbook/${e.slug}`}>{e.data.date} — {e.data.title}</a>
            <span class="meta">
              [{e.data.tags.join(', ')}]
              {e.data.project && ` · project: ${e.data.project}`}
            </span>
          </li>
        ))}
      </ul>
    </>
  ))}
</Base>
